AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Creates logging buckets for S3 access logs, ELB access logs, replicated to central log-archive account.
             
Parameters:
    AWSOrganizationID:
      Type: String
      Description: >
        The ID of your AWS Organization.
        Example: o-0123456789abcdef0
      
    LoggingAccountId:
      Type: 'String'
      Description: AWS Account Id of the log-archive account.
      AllowedPattern: "[0-9]{12}"
      
    LoggingRegion:
      Type: 'String'
      Description: >
        What region are the log buckets in? Region of the central logging bucket created in the Log archive account.
        Example: us-east-1 (If the central logging bucket are in US East (N. Virginia) us-east-1 AWS Region
        
    ElasticCloudID:
      Type: String
      Description: Cloud ID of Elastic Cluster Deployment
      NoEcho: true

    ElasticAPIKey:
      Type: String
      Description: RESTful API to provide access to deployment CRUD actions
      NoEcho: true
      
    BootstrapLambdaConfigBucket:
      Type: String
      Description: The S3 bucket name where the Bootstrap Lambda configuration zip file is stored.

    BootstrapLambdaConfigFilePath:
      Type: String
      Description: > 
        The path in the S3 bucket where the Bootstrap Lambda configuration zip file is located.
        Example: BootstrapLambdaCode/ElasticBootstrapMemberAccount.zip (If you have stored the zip file in a folder named BootstrapLambdaCode)
      
    IngestKinesisLogs:
      Type: String
      Default: "No"
      AllowedValues:
      - "Yes"
      - "No"
      Description: "Do you want to ingest Kinesis data streams to the Elastic Cloud? (Choose 'Yes' or 'No'). If yes, make sure you have Kinesis data stream already created."

    KinesisDataStreamArn:
      Type: CommaDelimitedList
      Default: ""
      Description: "Comma delimited list of Kinesis Data Stream ARNs (Provide the value only if you want to ingest the Kinesis data streams to the Elastic Cloud)"
      
    IngestCloudWatchLogs:
      Type: String
      Default: "No"
      AllowedValues:
      - "Yes"
      - "No"
      Description: "Do you want to ingest CloudWatch Log Group logs to the Elastic Cloud? (Choose 'Yes' or 'No'). If yes, provide log group ARNs."

    IngestEC2Logs:
      Type: String
      Default: "No"
      AllowedValues:
      - "Yes"
      - "No"
      Description: "Do you want to ingest EC2 logs to the Elastic Cloud? (Choose 'Yes' or 'No')."
    
    KibanaURL:
      Type: String
      Default: ""
      Description: "If you want to ingest EC2 logs to Elastic Cloud, then provide the Kibana URL in this section."

    EnrollmentToken:
      Type: String
      Default: ""
      Description: "If you want to ingest EC2 logs to Elastic Cloud, then provide the Enrollment Token in this section."

    CloudWatchLogGroupArns:
      Type: CommaDelimitedList
      Default: ""
      Description: "Comma delimited list of CloudWatch Log Group ARNs (Provide the value only if you want to ingest the CloudWatch Log Group logs to the Elastic Cloud)"
      
    DeployInVPC:
      Type: String
      Description: >
        'If you want to ingest either Kinesis data Streams or the CloudWatch logs to Elastic Cloud, an Elastic Serverless Forwarder will be deployed. Do you want to deploy this Elastic Serverless Forwarder in a VPC? (Enter "yes" or "no").
        Note: If yes, make sure a VPC is already been created in the region before deploying this CFT.' 
      Default: 'No'
      AllowedValues: ['Yes', 'No']

    VPCId:
      Type: String
      Description: 'Enter the VPC ID in which you want to deploy the Elastic Serverless Forwarder. Provide the value only if you want to deploy the Elastic Serverless Forwarder in the VPC'

    SubnetIds:
      Type: CommaDelimitedList
      Description: 'Enter the Subnet IDs (comma-separated) for the Elastic Serverless Forwarder. Provide the value only if you want to deploy the Elastic Serverless Forwarder in the VPC'
      ConstraintDescription: 'Please enter a valid list of Subnet IDs.'
    
Conditions:
  ShouldIngestKinesisDataStream: !Equals [!Ref IngestKinesisLogs, "Yes"]
  ShouldIngestCloudWatchLogs: !Equals [!Ref IngestCloudWatchLogs, "Yes"]
  ShouldDeployElasticForwarderInVPC: !Equals [!Ref DeployInVPC, "Yes"]
  ShouldIngestEC2InstanceLogs: !Equals [!Ref IngestEC2Logs, "Yes"]

  
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Log Archive Account Details
      Parameters:
      - LoggingAccountId
      - LoggingRegion
    - Label:
        default: AWS Organization ID
      Parameters:
      - AWSOrganizationID
    - Label:
        default: Elastic Cluster Deployment Details
      Parameters:
      - ElasticCloudID
      - ElasticAPIKey
    - Label:
        default: Elastic Bootstrap Lambda ZIP File Details
      Parameters:
      - BootstrapLambdaConfigBucket
      - BootstrapLambdaConfigFilePath
    - Label:
        default: Ingest EC2 Instance Logs
      Parameters:
      - IngestEC2Logs
      - KibanaURL
      - EnrollmentToken
    - Label:
        default: Ingest kinesis data stream (Optional)
      Parameters:
      - IngestKinesisLogs
      - KinesisDataStreamArn
    - Label:
        default: Ingest CloudWatch LogGroup Logs (Optional)
      Parameters:
      - IngestCloudWatchLogs
      - CloudWatchLogGroupArns
    - Label:
        default: Deploy Elastic Forwarder in a VPC (Optional)
      Parameters:
      - DeployInVPC
      - VPCId
      - SubnetIds
    ParameterLabels:
      ElasticCloudID:
        default: Elastic Cloud ID
      ElasticAPIKey:
        default: Elastic API Key
      LoggingAccountId:
        default: Account ID
      LoggingRegion:
        default: Logging Region
      AWSOrganizationID:
        default: Organization ID
      BootstrapLambdaConfigBucket:
        default: Bootstrap Lambda Config Bucket
      BootstrapLambdaConfigFilePath:
        default: Bootstrap Lambda Config File Path
      IngestEC2Logs:
        default: Ingest EC2 Logs
      KibanaURL:
        default: Kibana URL
      EnrollmentToken:
        default: Enrollment Token
      IngestKinesisLogs:
        default: Ingest Kinesis Logs
      KinesisDataStreamArn:
        default: Kinesis Data Stream ARNs
      IngestCloudWatchLogs:
        default: Ingest CloudWatch Logs
      CloudWatchLogGroupArns:
        default: CloudWatch LogGroup ARNs
      DeployInVPC:
        default: Deploy Serverless Forwarder In VPC
      VPCId:
        default: VPC ID
      SubnetIds:
        default: Subnet IDs

Mappings:
  VPCServiceName:
    af-south-1: 
      service: com.amazonaws.vpce.us-east-1.vpce-svc-0e42e1e06ed010238
    ap-east-1:
      service: com.amazonaws.vpce.ap-east-1.vpce-svc-0f96fbfaf55558d5c
    ap-northeast-1:
      service: com.amazonaws.vpce.ap-northeast-1.vpce-svc-0e1046d7b48d5cf5f
    ap-northeast-2:
      service: com.amazonaws.vpce.ap-northeast-2.vpce-svc-0d90cf62dae682b84
    ap-south-1:
      service: com.amazonaws.vpce.ap-south-1.vpce-svc-0e9c1ae5caa269d1b
    ap-southeast-1:
      service: com.amazonaws.vpce.ap-southeast-1.vpce-svc-0cbc6cb9bdb683a95
    ap-southeast-2:
      service: com.amazonaws.vpce.ap-southeast-2.vpce-svc-0cde7432c1436ef13
    ca-central-1:
      service: com.amazonaws.vpce.ca-central-1.vpce-svc-0d3e69dd6dd336c28
    eu-central-1:
      service: com.amazonaws.vpce.eu-central-1.vpce-svc-081b2960e915a0861
    eu-south-1:
      service: com.amazonaws.vpce.eu-south-1.vpce-svc-03d8fc8a66a755237
    eu-north-1:
      service: com.amazonaws.vpce.eu-north-1.vpce-svc-05915fc851f802294
    eu-west-1:
      service: com.amazonaws.vpce.eu-west-1.vpce-svc-01f2afe87944eb12b
    eu-west-2:
      service: com.amazonaws.vpce.eu-west-2.vpce-svc-0e42a2c194c97a1d0
    eu-west-3:
      service: com.amazonaws.vpce.eu-west-3.vpce-svc-0d6912d10db9693d1
    me-south-1:
      service: com.amazonaws.vpce.me-south-1.vpce-svc-0381de3eb670dcb48
    sa-east-1:
      service: com.amazonaws.vpce.sa-east-1.vpce-svc-0b2dbce7e04dae763
    us-east-1: 
      service: com.amazonaws.vpce.us-east-1.vpce-svc-0e42e1e06ed010238
    us-east-2:
      service: com.amazonaws.vpce.us-east-2.vpce-svc-02d187d2849ffb478
    us-west-1:
      service: com.amazonaws.vpce.us-west-1.vpce-svc-00def4a16a26cb1b4
    us-west-2:
      service: com.amazonaws.vpce.us-west-2.vpce-svc-0e69febae1fb91870
  PrivateHostedZoneDNSName:
    af-south-1:
      HostedZone: vpce.af-south-1.aws.elastic-cloud.com
    ap-east-1:
      HostedZone: vpce.ap-east-1.aws.elastic-cloud.com
    ap-northeast-1:
      HostedZone: vpce.ap-northeast-1.aws.elastic-cloud.com
    ap-northeast-2:
      HostedZone: vpce.ap-northeast-2.aws.elastic-cloud.com
    ap-south-1:
      HostedZone: vpce.ap-south-1.aws.elastic-cloud.com
    ap-southeast-1:
      HostedZone: vpce.ap-southeast-1.aws.elastic-cloud.com
    ap-southeast-2:
      HostedZone: vpce.ap-southeast-2.aws.elastic-cloud.com
    ca-central-1:
      HostedZone: vpce.ca-central-1.aws.elastic-cloud.com
    eu-central-1:
      HostedZone: vpce.eu-central-1.aws.elastic-cloud.com
    eu-south-1:
      HostedZone: vpce.eu-south-1.aws.elastic-cloud.com
    eu-north-1:
      HostedZone: vpce.eu-north-1.aws.elastic-cloud.com
    eu-west-1:
      HostedZone: vpce.eu-west-1.aws.elastic-cloud.com
    eu-west-2:
      HostedZone: vpce.eu-west-2.aws.elastic-cloud.com
    eu-west-3:
      HostedZone: vpce.eu-west-3.aws.elastic-cloud.com
    me-south-1:
      HostedZone: vpce.me-south-1.aws.elastic-cloud.com
    sa-east-1:
      HostedZone: vpce.sa-east-1.aws.elastic-cloud.com
    us-east-1: 
      HostedZone: vpce.us-east-1.aws.elastic-cloud.com
    us-east-2:
      HostedZone: vpce.us-east-2.aws.elastic-cloud.com
    us-west-1:
      HostedZone: vpce.us-west-1.aws.elastic-cloud.com
    us-west-2:
      HostedZone: vpce.us-west-2.aws.elastic-cloud.com        

Resources:
  ElasticSecret:
    Type: AWS::SecretsManager::Secret
    DependsOn: ElasticSSMSecretEncryptionKey
    Properties:
      Name: !Sub "ElasticCloudSecret-${AWS::StackName}"
      KmsKeyId: !Ref ElasticSSMSecretEncryptionKey
      SecretString: !Sub |
        {
          "ElasticCloudID": "${ElasticCloudID}",
          "APIKey": "${ElasticAPIKey}"
        }
        
  ElasticSSMSecretEncryptionKey:     # Create a KMS Key to encrypt the secrets in AWS SSM store
    Type: AWS::KMS::Key
    Properties:
      Description: Encrypt the secrets stored in the SSM Store.
      Enabled: true
      EnableKeyRotation: true
      KeyUsage: ENCRYPT_DECRYPT
      PendingWindowInDays: 7
      KeyPolicy:
        Version: 2012-10-17
        Id: sqs-use
        Statement:
          - Sid: Key Admin Usage
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: 
              - 'kms:*'
            Resource: '*'
          - Sid: Elastic-Lambda-Permission
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - 'kms:GenerateDataKey*'
              - 'kms:Decrypt'
            Resource: '*'

  ElasticSSMSecretKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/ElasticSSMSecretEncryptionKey
      TargetKeyId: !Ref ElasticSSMSecretEncryptionKey
        
  S3ReplicationRole:        #Role for S3 service to replicated objects to Log Archive S3 Bucket
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Action: 
              - "sts:AssumeRole"
            Effect: "Allow"
            Principal: 
              Service: 
                - "s3.amazonaws.com"
      Path: "/"
      RoleName: "elastic-AWS-S3-Replication"

  S3ReplicationRolePolicy: 
    Type: "AWS::IAM::ManagedPolicy"
    Properties: 
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Action:
              - s3:ListBucket
              - s3:GetBucketLocation
              - s3:GetReplicationConfiguration
              - s3:GetObjectVersionForReplication
              - s3:GetObjectVersion
              - s3:GetObjectVersionAcl
              - s3:GetObjectVersionTagging
              - s3:GetObjectRetention
              - s3:GetObjectLegalHold
            Effect: "Allow"
            Resource:
              - arn:aws:s3:::elastic-central-elb-access-logs-*/*
              - arn:aws:s3:::elastic-central-waf-access-logs-*/*
              - arn:aws:s3:::elastic-central-emr-access-logs-*/*
              - arn:aws:s3:::elastic-central-nf-access-logs-*/*
              - arn:aws:s3:::elastic-aws-emr-local-logs*/*
              - arn:aws:s3:::elastic-aws-emr-local-logs*
              - arn:aws:s3:::elastic-aws-elb-local-logs-*/*
              - arn:aws:s3:::elastic-aws-elb-local-logs-*
              - arn:aws:s3:::aws-waf-logs-elastic-local-logs-*/*
              - arn:aws:s3:::aws-waf-logs-elastic-local-logs-*
              - arn:aws:s3:::elastic-aws-nf-local-logs-*/*
              - arn:aws:s3:::elastic-aws-nf-local-logs-*
              - arn:aws:s3:::elastic-aws-cloudfront-local-logs-*/*
              - arn:aws:s3:::elastic-aws-cloudfront-local-logs-*
              - arn:aws:s3:::elastic-aws-cloudfront-local-logs-*/*
              - arn:aws:s3:::elastic-aws-cloudfront-local-logs-*
              - arn:aws:s3:::elastic-central-cloudfront-access-logs-*/*
              - arn:aws:s3:::elastic-central-cloudfront-access-logs-*
          - 
            Action:
              - s3:ReplicateObject
              - s3:ReplicateDelete
              - s3:ReplicateTags
              - s3:ObjectOwnerOverrideToBucketOwner
            Effect: "Allow"
            Resource:
              - arn:aws:s3:::elastic-central-elb-access-logs-*/*
              - arn:aws:s3:::elastic-central-waf-access-logs-*/*
              - arn:aws:s3:::elastic-central-emr-access-logs-*/*
              - arn:aws:s3:::elastic-central-nf-access-logs-*/*
              - arn:aws:s3:::elastic-central-cloudfront-access-logs-*/*
            Condition:
              StringEquals:
                aws:PrincipalOrgID:
                  - !Ref AWSOrganizationID
      ManagedPolicyName: "Elastic-AWS-S3-Replication"
      Roles: 
        - 
          Ref: "S3ReplicationRole"


  S3ElbLocalAccessLogBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3LocalLoggingBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub elastic-aws-elb-local-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LocalLoggingBucket
        LogFilePrefix: !Sub "elastic-aws-elb-local-logs-${AWS::AccountId}-${AWS::Region}/"
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination: 
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-elb-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId      
      VersioningConfiguration:
        Status: Enabled

  S3ElbAccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3ElbLocalAccessLogBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissionsCheck
            Action: s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource:
              - !Sub "arn:aws:s3:::${S3ElbLocalAccessLogBucket}/*"
          - Sid: LogDelivery
            Action: s3:PutObject
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3ElbLocalAccessLogBucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
          - Sid: LogDeliveryPermissionCheck
            Action: s3:GetBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3ElbLocalAccessLogBucket}"
              
  S3WafLocalAccessLogBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3LocalLoggingBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub aws-waf-logs-elastic-local-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LocalLoggingBucket
        LogFilePrefix: !Sub "aws-waf-logs-elastic-local-logs-${AWS::AccountId}-${AWS::Region}/"
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination:
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-waf-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId
      VersioningConfiguration:
        Status: Enabled

  S3WafAccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3WafLocalAccessLogBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissionsCheck
            Action: s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource:
              - !Sub "arn:aws:s3:::${S3WafLocalAccessLogBucket}/*"
          - Sid: LogDelivery
            Action: s3:PutObject
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3WafLocalAccessLogBucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
          - Sid: LogDeliveryPermissionCheck
            Action: s3:GetBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3WafLocalAccessLogBucket}"

  S3EmrLocalAccessLogBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3LocalLoggingBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub elastic-aws-emr-local-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LocalLoggingBucket
        LogFilePrefix: !Sub "elastic-aws-emr-local-logs-${AWS::AccountId}-${AWS::Region}/"
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination: 
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-emr-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId
      VersioningConfiguration:
        Status: Enabled

  S3EmrAccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3EmrLocalAccessLogBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissionsCheck
            Action: s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource:
              - !Sub "arn:aws:s3:::${S3EmrLocalAccessLogBucket}/*"
          - Sid: LogDelivery
            Action: s3:PutObject
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3EmrLocalAccessLogBucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
          - Sid: LogDeliveryPermissionCheck
            Action: s3:GetBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3EmrLocalAccessLogBucket}"

  S3NfLocalAccessLogBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3LocalLoggingBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub elastic-aws-nf-local-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LocalLoggingBucket
        LogFilePrefix: !Sub "elastic-aws-nf-local-logs-${AWS::AccountId}-${AWS::Region}/"
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination: 
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-nf-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId
      VersioningConfiguration:
        Status: Enabled

  S3NfAccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3NfLocalAccessLogBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissionsCheck
            Action: s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource:
              - !Sub "arn:aws:s3:::${S3NfLocalAccessLogBucket}/*"
          - Sid: LogDelivery
            Action: s3:PutObject
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3NfLocalAccessLogBucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
          - Sid: LogDeliveryPermissionCheck
            Action: s3:GetBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3NfLocalAccessLogBucket}"

  S3CloudfrontLocalAccessLogBucket:
    Type: AWS::S3::Bucket
    DependsOn: S3LocalLoggingBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub elastic-aws-cloudfront-local-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LocalLoggingBucket
        LogFilePrefix: !Sub "elastic-aws-cloudfront-local-logs-${AWS::AccountId}-${AWS::Region}/"
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination: 
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-cloudfront-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId
      VersioningConfiguration:
        Status: Enabled

  S3CloudfrontAccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3CloudfrontLocalAccessLogBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissionsCheck
            Action: s3:PutObject
            Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource:
              - !Sub "arn:aws:s3:::${S3CloudfrontLocalAccessLogBucket}/*"
          - Sid: LogDelivery
            Action: s3:PutObject
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3CloudfrontLocalAccessLogBucket}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
          - Sid: LogDeliveryPermissionCheck
            Action: s3:GetBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              - !Sub "arn:aws:s3:::${S3CloudfrontLocalAccessLogBucket}"
              
  S3LocalLoggingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
      BucketName: !Sub elastic-aws-local-s3-access-logs-${AWS::AccountId}-${AWS::Region}
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1
            Id: Remove replicated logs after 1 day
            NoncurrentVersionExpirationInDays: 1
            Status: Enabled
      ReplicationConfiguration:
        Role: !Sub arn:aws:iam::${AWS::AccountId}:role/elastic-AWS-S3-Replication
        Rules:
          - Prefix: ""
            Status: "Enabled"
            Destination: 
              AccessControlTranslation:
                Owner: Destination
              Bucket: !Sub arn:aws:s3:::elastic-central-s3-access-logs-${LoggingAccountId}-${LoggingRegion}
              Account: !Ref LoggingAccountId
      VersioningConfiguration:
        Status: Enabled
        
  ElasticServerlessForwarderEventMacro:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:eu-central-1:267093732750:applications/helper-macro-elastic-serverless-forwarder
        SemanticVersion: 1.9.0
    DependsOn:
    - TriggersBootstrapLambda
    Metadata:
      SamResourceId: ElasticServerlessForwarderEventMacro

  ElasticServerlessForwarderApplication:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:eu-central-1:267093732750:applications/helper-application-elastic-serverless-forwarder
        SemanticVersion: 1.9.0
      Parameters:
        ElasticServerlessForwarderS3ConfigFile: !Sub s3://${S3ConfigFileBucket}/config.yml
        ElasticServerlessForwarderSSMSecrets: !Ref ElasticSecret
        ElasticServerlessForwarderKMSKeys: !GetAtt ElasticSSMSecretEncryptionKey.Arn
        ElasticServerlessForwarderSQSEvents: ""
        ElasticServerlessForwarderS3SQSEvents: ""
        ElasticServerlessForwarderKinesisEvents:
          Fn::Join:
          - ','
          - Ref: KinesisDataStreamArn
        ElasticServerlessForwarderCloudWatchLogsEvents:
          Fn::Join:
          - ','
          - Ref: CloudWatchLogGroupArns
        ElasticServerlessForwarderS3Buckets: ""
        ElasticServerlessForwarderSecurityGroups: !If
          - ShouldDeployElasticForwarderInVPC
          - !GetAtt EndpointSecurityGroup.GroupId
          - ""
        ElasticServerlessForwarderSubnets: !If
          - ShouldDeployElasticForwarderInVPC
          - Fn::Join: [',', !Ref SubnetIds]
          - ""
    DependsOn: 
    - ElasticServerlessForwarderEventMacro
    Metadata:
      SamResourceId: ElasticServerlessForwarderApplication
      
  S3ConfigFileBucket:       #Bucket to store the config.yaml file
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub aws-config-bucket-${AWS::AccountId}-${AWS::Region}      
      VersioningConfiguration:
        Status: Enabled

  S3ConfigFileBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn: S3ConfigFileBucket
    Properties:
      Bucket: !Ref S3ConfigFileBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AWSBucketPermissions
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:GetBucketAcl
              - s3:ListBucket
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com 
            Resource:
              - Fn::Join:
                  - ''
                  - - 'arn:aws:s3:::'
                    - Ref: 'S3ConfigFileBucket'
                    - '/*'
              - Fn::Join:
                  - ''
                  - - 'arn:aws:s3:::'
                    - Ref: 'S3ConfigFileBucket'

  ElasticBootstrapLambdaForConfigFile:
    Type: 'AWS::Lambda::Function'
    DependsOn:
    - S3ConfigFileBucketPolicy
    - ElasticSecret
    Properties:
      FunctionName: !Sub Elastic-BootStrap-Lambda-${AWS::AccountId}-${AWS::Region}
      Handler: lambda_function.lambda_handler
      Role: !GetAtt BootstrapLambdaExecutionRole.Arn
      Runtime: python3.11
      Timeout: 300
      MemorySize: 128
      Code:
        S3Bucket: !Ref BootstrapLambdaConfigBucket
        S3Key: !Ref BootstrapLambdaConfigFilePath
      Environment:
        Variables:
          ELASTIC_SECRET_ARN: !Ref ElasticSecret
          S3_BUCKET_NAME: !Ref S3ConfigFileBucket
          INGEST_CLOUDWATCH_LOGS: !Ref IngestCloudWatchLogs
          CLOUDWATCH_LOG_GROUP_ARNS: !If
            - ShouldIngestCloudWatchLogs
            - Fn::Join: [',', !Ref CloudWatchLogGroupArns]
            - ""  # Set to an empty string if ShouldIngestCloudWatchLogs is false  
          INGEST_KINESIS_LOGS: !Ref IngestKinesisLogs
          KINESIS_DATA_STREAM_ARNS: !If
            - ShouldIngestKinesisDataStream
            - Fn::Join: [',', !Ref KinesisDataStreamArn]
            - ""  # Set to an empty string if ShouldIngestKinesisDataStream is false

  BootstrapLambdaExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - Effect: "Allow"
            Principal: 
              Service: 
              - "lambda.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'

  RolePolicies: 
    Type: 'AWS::IAM::Policy'
    Properties: 
      PolicyName: "ElasticBootstrapLambdaCustomPolicy"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - Effect: "Allow"
            Action:
            - "s3:PutObject"
            - "s3:DeleteObject"
            - "lambda:InvokeFunction"
            - "cloudformation:SignalResource"
            - "cloudformation:DescribeStackResources"
            - "cloudformation:DescribeStackEvents"
            Resource: "*" 
      Roles: 
        - Ref: "BootstrapLambdaExecutionRole"

  TriggersBootstrapLambda:
    Type: 'Custom::RunCode'
    DependsOn: ElasticBootstrapLambdaForConfigFile
    DeletionPolicy: Retain 
    Properties:
      ServiceToken: !GetAtt ElasticBootstrapLambdaForConfigFile.Arn
      
  VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: ShouldDeployElasticForwarderInVPC
    Properties:
      SecurityGroupIds: 
        - !GetAtt EndpointSecurityGroup.GroupId
      ServiceName: 
        !FindInMap 
          - VPCServiceName
          - !Ref 'AWS::Region'
          - service
      SubnetIds: !Ref SubnetIds
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
      
  EndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: ShouldDeployElasticForwarderInVPC
    Properties:
      GroupDescription: Elastic SecurityGroup 
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 9243
          ToPort: 9243
          CidrIp: 0.0.0.0/0
          
  PrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Condition: ShouldDeployElasticForwarderInVPC
    Properties:
      Name:
        !FindInMap 
          - PrivateHostedZoneDNSName
          - !Ref 'AWS::Region'
          - HostedZone
      VPCs: 
        - 
          VPCId: !Ref VPCId
          VPCRegion: !Sub ${AWS::Region}        
          
  VPCEndpointCNAMERecord:
    Type: AWS::Route53::RecordSet
    Condition: ShouldDeployElasticForwarderInVPC
    Properties:
      HostedZoneId: !Ref PrivateHostedZone
      Name: 
        Fn::Sub: "*.vpce.${AWS::Region}.aws.elastic-cloud.com"
      Type: CNAME
      TTL: '60'
      ResourceRecords:
      - !Select
        - 1
        - !Split
          - ':'
          - !Select [0, !GetAtt VPCEndpoint.DnsEntries]
  
  elasticVpc:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: "10.10.0.0/16"
      EnableDnsSupport: true
      EnableDnsHostnames: true

  elasticInternetGateway:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::InternetGateway"

  attachInternetGateway:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      InternetGatewayId:
        Ref: "elasticInternetGateway"
      VpcId:
        Ref: "elasticVpc"

  elasticSubnet:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::Subnet"
    Properties:
      AvailabilityZone: "us-east-1a"
      MapPublicIpOnLaunch: true
      VpcId:
        Ref: "elasticVpc"
      CidrBlock: "10.10.0.0/24"

  elasticRouteTable:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "elasticVpc"

  elasticRoute:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::Route"
    DependsOn: "attachInternetGateway"
    Properties:
      RouteTableId:
        Ref: "elasticRouteTable"
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId:
        Ref: "elasticInternetGateway"

  elasticSubnetRouteTableAssociation:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: "elasticSubnet"
      RouteTableId:
        Ref: "elasticRouteTable"

  InstanceSecurityGroup:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Allow SSH to client host"
      VpcId:
        Ref: "elasticVpc"
      SecurityGroupIngress:
        - IpProtocol: "tcp"
          FromPort: 0
          ToPort: 10000
          CidrIp: "0.0.0.0/0"
        - IpProtocol: "tcp"
          FromPort: 22
          ToPort: 22
          CidrIp: "0.0.0.0/0"

  elasticEc2Instance:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: "ami-0fc5d935ebf8bc3bc"
      InstanceType: "t2.micro"
      SecurityGroupIds:
        - Ref: "InstanceSecurityGroup"
      BlockDeviceMappings:
        - DeviceName: "/dev/sda1"
          Ebs:
            Encrypted: false
            DeleteOnTermination: true
            VolumeSize: 30
            VolumeType: "gp2"
      KeyName:
        Ref: "NewKeyPair"
      SubnetId:
        Ref: "elasticSubnet"
      UserData: !Base64 
        'Fn::Sub': |
          #!/bin/bash -xe 
           echo 'Starting user data script' > /var/log/user_data.log 
           sudo apt update 
           sudo apt install jq -y 
           curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.11.0-linux-x86_64.tar.gz 
           tar xzvf elastic-agent-8.11.0-linux-x86_64.tar.gz 
           cd /elastic-agent-8.11.0-linux-x86_64 
           sudo ./elastic-agent install --url=${KibanaURL} --enrollment-token=${EnrollmentToken} -f 
      Tags:
        - Key: "Name"
          Value: "Elastic-EC2"

  NewKeyPair:
    Condition: ShouldIngestEC2InstanceLogs
    Type: "AWS::EC2::KeyPair"
    Properties:
      KeyName: "elasticKeyPair"
